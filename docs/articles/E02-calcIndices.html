<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>02 - Calculation of Indices â€¢ mapme.vegetation</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="02 - Calculation of Indices">
<meta property="og:description" content="mapme.vegetation">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mapme.vegetation</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/E01-download.html">01 - Download</a>
    </li>
    <li>
      <a href="../articles/E02-calcIndices.html">02 - Calculation of Indices</a>
    </li>
    <li>
      <a href="../articles/E03-zonalstats.html">03 - Zonal Statistics</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="E02-calcIndices_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="E02-calcIndices_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="E02-calcIndices_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>02 - Calculation of Indices</h1>
            
      
      
      <div class="hidden name"><code>E02-calcIndices.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="co">#&gt; Linking to GEOS 3.8.0, GDAL 3.0.4, PROJ 6.3.1</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mapme.vegetation</span><span class="op">)</span></code></pre></div>
<p>In this tutorial we are explaining how vegetation indices are calculated under the hood of the package. The most important tool we are using is the <a href="https://cran.r-project.org/web/packages/gdalcubes/index.html">gdalcubes</a> package. This packages makes it very easy to create spatio-temporal aggregates of satellite observations for a given area of interest (AOI) and user defined aggregation methods and time-frames. Here, we assume that you already downloaded a number of files using the process outlined in the <a href="E01-download.html">Download</a> article with the option <code>create_cloudmask</code> enabled. The function will not work on Sentinel 2 directories which do not contain cloud masks. However the cloud mask can be created after the download by calling <code><a href="../reference/createCloudMask.html">createCloudMask()</a></code> on the safe directories.</p>
<p>In order to check the available indices you can use the <code><a href="../reference/check_indices.html">check_indices()</a></code> function which will deliver you a data.frame with available indices. We thankfully adapted these indices from the awesome<code><a href="http://sen2r.ranghetti.info/reference/list_indices.html">sen2r::list_indices()</a></code> package. Here we print the first 10 available indices.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/check_indices.html">check_indices</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">]</span>
<span class="co">#&gt;                                        longname      name</span>
<span class="co">#&gt; 1            Aerosol free vegetation index 1600  AFRI1600</span>
<span class="co">#&gt; 2            Aerosol free vegetation index 2100  AFRI2100</span>
<span class="co">#&gt; 3                 Anthocyanin reflectance index       ARI</span>
<span class="co">#&gt; 4                      Ashburn Vegetation Index       AVI</span>
<span class="co">#&gt; 5  Atmospherically Resistant Vegetation Index 2     ARVI2</span>
<span class="co">#&gt; 6      Blue-wide dynamic range vegetation index    BWDRVI</span>
<span class="co">#&gt; 7                    Browning Reflectance Index       BRI</span>
<span class="co">#&gt; 8                       Chlorophyll Index Green   CIgreen</span>
<span class="co">#&gt; 9                      Chlorophyll IndexRedEdge CIrededge</span>
<span class="co">#&gt; 10                             Coloration Index        CI</span>
<span class="co">#&gt;                                                  link</span>
<span class="co">#&gt; 1  http://www.indexdatabase.de/db/i-single.php?id=393</span>
<span class="co">#&gt; 2  http://www.indexdatabase.de/db/i-single.php?id=395</span>
<span class="co">#&gt; 3  http://www.indexdatabase.de/db/i-single.php?id=214</span>
<span class="co">#&gt; 4  http://www.indexdatabase.de/db/i-single.php?id=574</span>
<span class="co">#&gt; 5  http://www.indexdatabase.de/db/i-single.php?id=396</span>
<span class="co">#&gt; 6  http://www.indexdatabase.de/db/i-single.php?id=136</span>
<span class="co">#&gt; 7  http://www.indexdatabase.de/db/i-single.php?id=480</span>
<span class="co">#&gt; 8  http://www.indexdatabase.de/db/i-single.php?id=128</span>
<span class="co">#&gt; 9  http://www.indexdatabase.de/db/i-single.php?id=131</span>
<span class="co">#&gt; 10  http://www.indexdatabase.de/db/i-single.php?id=11</span>
<span class="co">#&gt;                                       s2_formula</span>
<span class="co">#&gt; 1  (band_8-0.66*(band_11)/(band_8+0.66*band_11))</span>
<span class="co">#&gt; 2   (band_8-0.5*(band_12)/(band_8+0.56*band_12))</span>
<span class="co">#&gt; 3                      (1)/(band_3)-(1)/(band_5)</span>
<span class="co">#&gt; 4                              2.0*band_9-band_4</span>
<span class="co">#&gt; 5   -0.18+1.17*((band_8-band_4)/(band_8+band_4))</span>
<span class="co">#&gt; 6        (0.1*band_8-band_2)/(0.1*band_8+band_2)</span>
<span class="co">#&gt; 7           ((1)/(band_3)-(1)/(band_5))/(band_8)</span>
<span class="co">#&gt; 8                            (band_8)/(band_3)-1</span>
<span class="co">#&gt; 9                            (band_8)/(band_5)-1</span>
<span class="co">#&gt; 10                      (band_4-band_2)/(band_4)</span></code></pre></div>
<p>To calculate an index we will have to specify its short name found in the <code>name</code> column of the data.frame. Currently, there is support for a total number of 206 different indices, however, the function can only process one index at a time thus if you are interested in more than one index you should loop over the function call.</p>
<p>Here is what the function call to calculate the NDVI looks like assuming that in the files variables the output of a recursive file search for <code>.jp2</code> and <code>.tif</code> files on the SAFE directories is found.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">files</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="st">"&lt;path&gt;/&lt;to&gt;/&lt;SAFES&gt;"</span>, pattern <span class="op">=</span> <span class="st">".jp2|.tif"</span>, recursive <span class="op">=</span> <span class="cn">T</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">aoi</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"testregion.gpkg"</span>, package <span class="op">=</span> <span class="st">"mapme.vegetation"</span><span class="op">)</span><span class="op">)</span>
<span class="va">aoi</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">aoi</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="st">"EPSG:3857"</span><span class="op">)</span><span class="op">)</span>
<span class="va">rasterfiles</span> <span class="op">=</span> <span class="fu"><a href="../reference/calcIndex.html">calcIndex</a></span><span class="op">(</span><span class="va">files</span>,
                        aoi <span class="op">=</span> <span class="va">aoi</span>, 
                        epsg <span class="op">=</span> <span class="st">"EPSG:3857"</span>, 
                        dx <span class="op">=</span> <span class="fl">20</span>, 
                        dy <span class="op">=</span> <span class="fl">20</span>, 
                        dt <span class="op">=</span> <span class="st">"P1M"</span>, 
                        aggregation <span class="op">=</span> <span class="st">"mean"</span>, 
                        resampling <span class="op">=</span> <span class="st">"bilinear"</span>, 
                        tmpagg <span class="op">=</span> <span class="cn">FALSE</span>,
                        timeframe <span class="op">=</span> <span class="st">"complete"</span>, 
                        index <span class="op">=</span> <span class="st">"NDVI"</span>, 
                        label <span class="op">=</span> <span class="st">"NDVI"</span>, 
                        outdir <span class="op">=</span> <span class="st">"."</span>, 
                        ncores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p>Letâ€™s go through the parameters one by one. The <code>files</code> variable was already explained above. It comprises all single band files <strong>including</strong> the cloud mask for each Sentinel 2 image. Note that the default file names cannot be changed because <code><a href="../reference/calcIndex.html">calcIndex()</a></code> retrives the associated timestemp for each file from the actual filename. The aoi represents an <code>sf</code> object to determine the spatial extent of the analysis by computing the bounding box of the object and using its edge coordinates. You actually do not have to transform the object to the desired output projection beforehand because the function will do so internally if the crs differs, however, it is good advise to manually transform the <code>aoi</code>. In the <code>epsg</code> variable we define the desired output reference system. This can be any EPSG code, proj4 string or other formats which are understood by GDAL (see <code><a href="https://rdrr.io/pkg/gdalcubes/man/cube_view.html">gdalcubes::cube_view()</a></code> for more information). <code>dx</code> and <code>dy</code> are the size of the resulting pixels in x and y direction. Their unit depends on the reference system sepecified in the <code>epsg</code> option, thus extra care should be taken that to get things right here. In the example above we are using the Web Mercator projection thus the unit is represented as 20 meters. <code>dt</code> specifies the resolution of the time dimension as an ISO8601 string, thus in the example above it represents a monthly resolution. This means that after the spatial warping to the desired CRS and spatial resolution, all images of the same month will be aggregated. The method of the temporal aggregation is specifed in the <code>aggregation</code> option while any GDAL supported image transformation for the spatial warping can be specified in the <code>resampling</code> option.</p>
<p>In the example above we set <code>tmpagg = FALSE</code> which means that the time dimension is not going to be reduced in the end of the calculation. In the present case this is the desired behaviour because we are interested in monthly NDVI values. However, let us assume that we downloaded a seasonal dataset comprising the all Sentinel 2 datasets for the months June and July for each of the years 2016 to 2019. Our goal is to retrive one raster for each year indicating the mean between these two months. Unfortunately, <code>gdalcubes</code> does not support irregular time dimensions, for this reason we would have to process each year individually. What we do not want in this case is to aggregate the raw reflectance values over the complete two months and then calculate the NDVI. Rather we want the NDVI calculated individually for each image, aggregate the images to a monthly resolution and then calculate the mean of the NDVI for the two months. In cases like this we can set <code>tmpagg = TRUE</code> which will reduce the resulting time dimension by applying the mean calculation. In these cases we also would have to set <code>timeframe = "seasonal"</code> to let the function know to calculate on different years seperatly. If this option is specified, you also have to specify a <code>years</code> vector containing the different years for the calculation as characters.</p>
<p>The <code>outdir</code> and <code>label</code> parameters expect charachter vectors. The first specifying the directory where the output files are written and the second specyfing a label which is appended to the filename. Finally the parameters <code>threads</code> expects a numeric value indicating how many threads should be made available to the calculation for parallel processing.</p>
<p>The function will return a character vector pointing to the written <code>GTiff</code> files. The number of output files depends on how the function treats the time dimension because one file is written per final time dimension. The naming convention follows: <code>&lt;outdir&gt;/&lt;label&gt;&lt;timestemp&gt;.tif</code></p>
<p>The next step in a given analysis now would be to extract zonal statistics for a number of polygons we are interested in from the raster files we processed here. This is explained in the next article on <a href="E03-zonalstats.html">zonal statistics</a>.</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by KfW Bankengruppe, Darius GÃ¶rgen, Fabian LÃ¶w.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
