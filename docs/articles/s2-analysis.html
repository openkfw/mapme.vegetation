<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Analysis • sen2tool</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Analysis">
<meta property="og:description" content="sen2tool">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sen2tool</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Analysis</h1>
                        <h4 class="author">Darius Görgen</h4>
            
            <h4 class="date">2020-07-02</h4>
      
      
      <div class="hidden name"><code>s2-analysis.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">raster</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">sf</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">sen2tool</span>)</pre></body></html></div>
<div id="translation-to-gtiff" class="section level2">
<h2 class="hasAnchor">
<a href="#translation-to-gtiff" class="anchor"></a>Translation to GTiff</h2>
<p>Once the raw SAFE data for a given area of intereset (AOI) is downloaded to your local machine there are several steps needed for a proper pre-processing. The very first of them is to translate the SAFE format to <code>.tif</code> files so they can be easily handled with the <code>raster</code> package and other GI tools.</p>
<p>To speed up the process we build a wrapper function around <code><a href="https://rdrr.io/pkg/sen2r/man/s2_translate.html">sen2r::s2_translate()</a></code> which uses multi-core processing to translate several files in parallel. For this function to work, <code>sen2cor</code> needs to be installed locally. For this, the function has the <code>sen2cor</code> option where users can specify the local path to the installation. If it is not found there it will be downloaded and installed under the very same directory automatically.</p>
<p>The variable <code>safedirs</code> is expected to be a charachter vector including the names of the SAFE directories for processing. In most cases this will be the output of <code><a href="../reference/downloadS2.html">sen2tool::downloadS2</a></code>. The variable <code>datadir</code> points to the parent directory in which the the SAFE directories are found and where in most cases the GTiff files are written to. This depends on the input of the variable <code>outdir</code>. If it is a relative path, this path is searched from the input in <code>datadir</code>. Note that it is mandatory that the parent directory exists. If it is an absolute path, the GTiff files will be written there.</p>
<p>The function only applies a translation to GTiff without any further processing except that all layers are resampled to a 10 meters resolution. This includes the S2 bands which come in 20 or 60 meters resolution. With the variable <code>ncores</code> you can specify the number of cores used for the parallel processing of the SAFE data. This functionality currently is only supported on UNIX like systems. In case of a Windows OS, the function defaults to sequential processing.</p>
<p>The function call then looks like this, assuming that the SAFE directories are found in the current directory in the <code>L1C</code> directory:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">safes</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="st">"./L1C"</span>, <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"SAFE"</span>)

<span class="no">tiffs</span> <span class="kw">=</span> <span class="fu"><a href="../reference/transTifS2.html">transTifS2</a></span>(<span class="no">safes</span>,
                   <span class="kw">datadir</span> <span class="kw">=</span>  <span class="st">"./L1C"</span>,
                   <span class="kw">outdir</span> <span class="kw">=</span> <span class="st">"./tifs"</span>,
                   <span class="kw">ncores</span> <span class="kw">=</span> <span class="fl">2</span>,
                   <span class="kw">sen2cor</span> <span class="kw">=</span> <span class="st">"/opt/sen2cor"</span>)</pre></body></html></div>
<p>This function call first lists all the files in the <code>L1C</code> directory assuming that the there are only pre-downloaded driectories which include the charachter <code>"SAFE"</code>. We additationally tell the function that it will find these directories in the <code>L1C/</code> directory and to write the processed GTiff files to <code>tifs/</code>. Also, we use two cores to process two tiles in parallel. We also tell the function that the <code>sen2cor</code> installation is found in <code>/opt/</code> or to install it there otherwise.</p>
</div>
<div id="cloud-removal" class="section level2">
<h2 class="hasAnchor">
<a href="#cloud-removal" class="anchor"></a>Cloud Removal</h2>
<p>Once the S2 data is translated to GTiff we can apply the cloud removal process. It is important that the original SAFE directories are still found locally, because they include a simple cloud mask which can be used to save some computation time. For this process the developed the <code><a href="../reference/cloudRemovalS2.html">cloudRemovalS2()</a></code> routine.</p>
<p>As input the function expects again a <code>datadir</code> variable, which represents the directory in which the original SAFE data is found. Additionally, we have to specify the directory where we find the GTiff files we processed in the earlier step. With the variable <code>outdir</code> we can specify a directory to where the cloud-free GTiff file are going to be written to.</p>
<p>The function expects to matching inputs on the SAFE directories and the corresponding GTiff files. The most convinient is to use the output of the <code><a href="../reference/downloadS2.html">downloadS2()</a></code> and <code><a href="../reference/transTifS2.html">transTifS2()</a></code> functions. Also, you can specify a buffer size in meters to buffer the clouds for the given amount in order to avoid including mixed signals from pixels in the approximity of clouds.</p>
<p>In addition to that, the functions expects an aoi input represented by an <code>sf</code>-object to crop the resulting GTiff files. Note, that this object should be in the same projection as the processed GTiff file, thus we recommend to reproject it prior to calling the cloud removal routine.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r">r = raster(tiffs[1])
aoi = st_transform(aoi, st_crs(r)</pre></body></html></div>
<p>The final function call then looks like this, assuming the directory structure explained above is valid:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">tiffs_clean</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cloudRemovalS2.html">cloudRemovalS2</a></span>(<span class="kw">datadir</span> <span class="kw">=</span> <span class="st">"./L1C"</span>,
                       <span class="kw">outdir</span> <span class="kw">=</span> <span class="st">"./clouds"</span>,
                       <span class="kw">tifdir</span> <span class="kw">=</span> <span class="st">"./tifs"</span>,
                       <span class="kw">safedirs</span> <span class="kw">=</span> <span class="no">safes</span>,
                       <span class="kw">tiffiles</span> <span class="kw">=</span> <span class="no">tiffs</span>,
                       <span class="kw">aoi</span> <span class="kw">=</span> <span class="no">aoi</span>,
                       <span class="kw">buffer</span> <span class="kw">=</span> <span class="fl">100</span>)</pre></body></html></div>
</div>
<div id="calculation-of-indices" class="section level2">
<h2 class="hasAnchor">
<a href="#calculation-of-indices" class="anchor"></a>Calculation of Indices</h2>
<p>To calculate indices we again build a wrapper function around <code><a href="https://rdrr.io/pkg/sen2r/man/s2_calcindices.html">sen2r::s2_calcindices()</a></code>. This function, similar to the <code>transTifS1()</code> function is able to process GTiff files in parallel under UNIX alikes. In the <code>indices</code> variable a number of indices to be calculated can be handed to the function. Each of these will get its own subdirectory within the directory specifed in the <code>outdir</code> variable. As input to the function it is enough to hand the cloud removed GTiff files, most conviniently the output from <code><a href="../reference/cloudRemovalS2.html">cloudRemovalS2()</a></code>. In order to check all supported indices be advised to use the function <code><a href="https://rdrr.io/pkg/sen2r/man/list_indices.html">sen2r::list_indices()</a></code> which gives you a comprehensive list to choose from. Similar to the <code><a href="../reference/transTifS2.html">transTifS2()</a></code> function, this function need a working installation of <code>sen2cor</code> which is checked before the calculation.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r">
<span class="no">indices</span> <span class="kw">=</span> <span class="fu"><a href="../reference/calcIndicesS2.html">calcIndicesS2</a></span>(<span class="kw">indices</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"NDVI"</span>, <span class="st">"NDBI"</span>),
                        <span class="kw">outdir</span> <span class="kw">=</span> <span class="st">"./indices"</span>,
                        <span class="kw">files</span> <span class="kw">=</span> <span class="no">tiffs_clean</span>,
                        <span class="kw">ncores</span> <span class="kw">=</span> <span class="fl">2</span>,
                        <span class="kw">sen2cor</span> <span class="kw">=</span> <span class="st">"/opt/sen2cor"</span>)</pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://maptailor.net/">MapTailor GbR</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
